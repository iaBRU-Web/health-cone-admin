<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI Assistant â€” HealthCone</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet"/>
<style>
  :root{--green-deep:#0d2b1a;--green-mid:#1a4d2e;--green-bright:#2d7a4f;--cyan:#00e5c8;--cyan-dim:#00b49e;--ivory:#f5f0e8;--red-alert:#ff4d4d;--text-main:#f5f0e8;--text-dim:#9ab8a8;--card-bg:rgba(255,255,255,0.04);--card-border:rgba(0,229,200,0.12)}
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{font-family:'DM Sans',sans-serif;background:var(--green-deep);color:var(--text-main);overflow:hidden;display:flex;flex-direction:column}
  body::before{content:'';position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse 60% 50% at 80% 10%,rgba(0,229,200,0.05) 0%,transparent 60%),radial-gradient(ellipse 40% 60% at 20% 90%,rgba(45,122,79,0.08) 0%,transparent 60%);pointer-events:none}

  /* NAV */
  nav{position:relative;z-index:100;padding:0 2rem;height:68px;flex-shrink:0;display:flex;align-items:center;justify-content:space-between;background:rgba(13,43,26,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--card-border)}
  .nav-logo{display:flex;align-items:center;gap:10px;text-decoration:none;font-family:'Syne',sans-serif;font-weight:800;font-size:1.25rem;color:var(--text-main)}
  .nav-logo svg{width:32px;height:32px}
  .nav-links{display:flex;align-items:center;gap:0.25rem}
  .nav-links a{text-decoration:none;color:var(--text-dim);font-size:0.88rem;font-weight:500;padding:0.45rem 1rem;border-radius:8px;transition:color 0.2s,background 0.2s}
  .nav-links a:hover,.nav-links a.active{color:var(--cyan);background:rgba(0,229,200,0.08)}
  .nav-cta{background:var(--cyan)!important;color:var(--green-deep)!important;font-weight:700!important;padding:0.45rem 1.2rem!important;border-radius:8px!important}
  .hamburger{display:none;flex-direction:column;gap:5px;cursor:pointer;padding:4px}
  .hamburger span{display:block;width:24px;height:2px;background:var(--text-main);border-radius:2px}

  /* MOBILE NAV */
  .mobile-menu{display:none;position:fixed;top:68px;left:0;right:0;background:rgba(13,43,26,0.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--card-border);padding:1rem 2rem 1.5rem;flex-direction:column;gap:0.5rem;z-index:200}
  .mobile-menu.open{display:flex}
  .mobile-menu a{text-decoration:none;color:var(--text-dim);font-size:1rem;padding:0.6rem 0;border-bottom:1px solid var(--card-border);transition:color 0.2s}
  .mobile-menu a:hover,.mobile-menu a.active{color:var(--cyan)}
  @media(max-width:768px){.nav-links{display:none}.hamburger{display:flex}}

  /* CHAT SHELL */
  .chat-shell{display:flex;flex:1;overflow:hidden;position:relative;z-index:1}

  /* SIDEBAR */
  .sidebar{width:280px;flex-shrink:0;background:rgba(13,43,26,0.6);border-right:1px solid var(--card-border);display:flex;flex-direction:column;padding:1.2rem;gap:0.8rem;overflow:hidden}
  @media(max-width:768px){.sidebar{display:none}}
  .sidebar-title{font-family:'Syne',sans-serif;font-size:0.7rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:var(--text-dim);padding:0.4rem 0.6rem}
  .new-chat-btn{display:flex;align-items:center;gap:8px;background:rgba(0,229,200,0.1);border:1px solid rgba(0,229,200,0.2);color:var(--cyan);font-family:'Syne',sans-serif;font-size:0.85rem;font-weight:700;padding:0.7rem 1rem;border-radius:10px;cursor:pointer;transition:background 0.2s;width:100%;text-align:left}
  .new-chat-btn:hover{background:rgba(0,229,200,0.18)}
  .chat-history{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:0.3rem}
  .chat-history::-webkit-scrollbar{width:4px}
  .chat-history::-webkit-scrollbar-thumb{background:rgba(0,229,200,0.2);border-radius:2px}
  .history-item{padding:0.65rem 0.8rem;border-radius:8px;font-size:0.82rem;color:var(--text-dim);cursor:pointer;transition:background 0.2s;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .history-item:hover{background:rgba(255,255,255,0.05);color:var(--text-main)}
  .history-item.active{background:rgba(0,229,200,0.08);color:var(--cyan)}
  .model-section{border-top:1px solid var(--card-border);padding-top:0.8rem;margin-top:auto}
  .model-label{font-size:0.7rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.4rem;display:block}
  .model-select{width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--card-border);color:var(--text-main);font-family:'DM Sans',sans-serif;font-size:0.82rem;padding:0.5rem 0.8rem;border-radius:8px;cursor:pointer;outline:none;appearance:none}
  .model-select:focus{border-color:var(--cyan)}
  .model-select option{background:#0d2b1a}

  /* CHAT AREA */
  .chat-area{flex:1;display:flex;flex-direction:column;min-width:0}
  .messages{flex:1;overflow-y:auto;padding:2rem;display:flex;flex-direction:column;gap:1.5rem}
  .messages::-webkit-scrollbar{width:6px}
  .messages::-webkit-scrollbar-thumb{background:rgba(0,229,200,0.15);border-radius:3px}

  /* WELCOME SCREEN */
  .welcome{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;text-align:center;padding:2rem;gap:1.5rem;min-height:400px}
  .welcome-icon{width:72px;height:72px;background:linear-gradient(135deg,rgba(0,229,200,0.15),rgba(45,122,79,0.2));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:2rem}
  .welcome h2{font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800}
  .welcome p{color:var(--text-dim);max-width:440px;line-height:1.7;font-size:0.92rem}
  .suggestion-chips{display:flex;flex-wrap:wrap;gap:0.6rem;justify-content:center;max-width:560px}
  .chip{background:var(--card-bg);border:1px solid var(--card-border);color:var(--text-dim);font-size:0.8rem;padding:0.5rem 1rem;border-radius:100px;cursor:pointer;transition:border-color 0.2s,color 0.2s}
  .chip:hover{border-color:var(--cyan);color:var(--cyan)}

  /* MESSAGE BUBBLES */
  .msg{display:flex;gap:1rem;animation:msgIn 0.3s ease both;max-width:820px;width:100%}
  @keyframes msgIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
  .msg.user{flex-direction:row-reverse;margin-left:auto}
  .msg.ai{margin-right:auto}
  .msg-avatar{width:36px;height:36px;border-radius:10px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-family:'Syne',sans-serif;font-size:0.72rem;font-weight:800;letter-spacing:-0.5px}
  .msg.ai   .msg-avatar{background:linear-gradient(135deg,rgba(0,229,200,0.2),rgba(45,122,79,0.3));color:var(--cyan)}
  .msg.user .msg-avatar{background:rgba(255,255,255,0.08);color:var(--text-dim)}
  .msg-bubble{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:1rem 1.2rem;font-size:0.92rem;line-height:1.75;max-width:calc(100% - 52px)}
  .msg.user .msg-bubble{background:rgba(0,229,200,0.08);border-color:rgba(0,229,200,0.2)}
  .msg-bubble strong{color:var(--cyan)}
  .msg-bubble em{color:var(--ivory-dim);font-style:italic}
  .msg-bubble ul,.msg-bubble ol{padding-left:1.3rem;margin:0.5rem 0}
  .msg-bubble li{margin:0.3rem 0;color:var(--text-dim)}
  .msg-bubble code{background:rgba(0,0,0,0.35);padding:0.15rem 0.45rem;border-radius:4px;font-family:monospace;font-size:0.84em;color:var(--cyan)}
  .msg-bubble h3{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;margin:0.7rem 0 0.3rem;color:var(--text-main)}
  .msg-bubble p+p{margin-top:0.6rem}
  .msg-bubble hr{border:none;border-top:1px solid var(--card-border);margin:0.8rem 0}

  /* TYPING INDICATOR */
  .typing-bubble{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;padding:1rem 1.4rem;display:inline-flex;gap:6px;align-items:center}
  .typing-dot{width:7px;height:7px;background:var(--cyan);border-radius:50%;opacity:0.4;animation:typingDot 1.2s ease-in-out infinite}
  .typing-dot:nth-child(2){animation-delay:0.2s}
  .typing-dot:nth-child(3){animation-delay:0.4s}
  @keyframes typingDot{0%,80%,100%{transform:scale(1);opacity:0.35}40%{transform:scale(1.4);opacity:1}}

  /* INPUT AREA */
  .input-area{border-top:1px solid var(--card-border);background:rgba(13,43,26,0.85);backdrop-filter:blur(20px);padding:1.2rem 2rem;flex-shrink:0}
  .input-row{display:flex;gap:0.8rem;align-items:flex-end;max-width:820px;margin:0 auto}
  .input-wrap{flex:1;background:rgba(255,255,255,0.05);border:1px solid var(--card-border);border-radius:14px;padding:0.8rem 1rem;display:flex;gap:0.6rem;align-items:flex-end;transition:border-color 0.2s}
  .input-wrap:focus-within{border-color:rgba(0,229,200,0.35)}
  textarea{flex:1;background:transparent;border:none;outline:none;color:var(--text-main);font-family:'DM Sans',sans-serif;font-size:0.93rem;line-height:1.5;resize:none;max-height:140px;min-height:24px}
  textarea::placeholder{color:var(--text-dim)}
  .send-btn{width:40px;height:40px;background:var(--cyan);border:none;border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:opacity 0.2s,transform 0.15s}
  .send-btn:hover:not(:disabled){opacity:0.85;transform:scale(1.06)}
  .send-btn:disabled{opacity:0.35;cursor:not-allowed}
  .input-footer{text-align:center;font-size:0.72rem;color:var(--text-dim);margin-top:0.6rem;max-width:820px;margin-left:auto;margin-right:auto}
  .input-footer a{color:var(--cyan);text-decoration:none}

  /* MOBILE MODEL SELECT */
  .mobile-model{display:none;margin-bottom:0.6rem}
  @media(max-width:768px){.mobile-model{display:block}}
  .mobile-model select{width:100%;background:rgba(255,255,255,0.05);border:1px solid var(--card-border);color:var(--text-main);font-family:'DM Sans',sans-serif;font-size:0.82rem;padding:0.5rem 0.8rem;border-radius:8px;cursor:pointer;outline:none}
  .mobile-model select option{background:#0d2b1a}

  /* ERROR STATE */
  .msg-error .msg-bubble{border-color:rgba(255,77,77,0.3);background:rgba(255,77,77,0.05);color:#ff9090}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <a href="/" class="nav-logo">
    <svg viewBox="0 0 32 32" fill="none">
      <circle cx="16" cy="16" r="15" stroke="#00e5c8" stroke-width="1.5"/>
      <path d="M6 16 L10 11 L13 18 L16 8 L19 20 L22 14 L26 16" stroke="#00e5c8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M16 22 C16 22 12 18.5 12 16.5 C12 14.8 13.3 14 14.5 14 C15.3 14 16 14.6 16 14.6 C16 14.6 16.7 14 17.5 14 C18.7 14 20 14.8 20 16.5 C20 18.5 16 22 16 22Z" fill="#00e5c8" opacity="0.7"/>
    </svg>
    Health<span style="color:var(--cyan)">Cone</span>
  </a>
  <div class="nav-links">
    <a href="/">Home</a>
    <a href="/features">Features</a>
    <a href="/about">About</a>
    <a href="/assistant" class="active">AI Assistant</a>
    <a href="/admin">Admin</a>
    <a href="/assistant" class="nav-cta">Try Now â†’</a>
  </div>
  <div class="hamburger" onclick="toggleMenu()"><span></span><span></span><span></span></div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <a href="/">Home</a>
  <a href="/features">Features</a>
  <a href="/about">About</a>
  <a href="/assistant" class="active">AI Assistant</a>
  <a href="/admin">Admin</a>
</div>

<div class="chat-shell">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="sidebar-title">HealthCone AI</div>
    <button class="new-chat-btn" onclick="newChat()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
      </svg>
      New Chat
    </button>
    <div class="chat-history" id="chatHistory"></div>
    <div class="model-section">
      <span class="model-label">AI Model</span>
      <select class="model-select" id="modelSelect">
        <option value="groq-1">Groq â€” LLaMA 3.3 70B #1</option>
        <option value="groq-2">Groq â€” LLaMA 3.3 70B #2</option>
        <option value="groq-3">Groq â€” LLaMA 3.3 70B #3</option>
        <option value="groq-4">Groq â€” LLaMA 3.3 70B #4</option>
      </select>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area">
    <div class="messages" id="messages">
      <div class="welcome" id="welcomeScreen">
        <div class="welcome-icon">ğŸ¥</div>
        <h2>HealthCone AI Assistant</h2>
        <p>Powered by Bruno-GPT5 â€” ask anything about heart health, HealthCone features, wellness tips, or emergency guidance. I'm here for you.</p>
        <div class="suggestion-chips">
          <div class="chip" onclick="sendSuggestion('What is HealthCone and how does it work?')">What is HealthCone?</div>
          <div class="chip" onclick="sendSuggestion('What heart rate is considered dangerous?')">Dangerous heart rate?</div>
          <div class="chip" onclick="sendSuggestion('What should I do during a cardiac emergency?')">Cardiac emergency steps</div>
          <div class="chip" onclick="sendSuggestion('How does HealthCone detect heart problems?')">How does detection work?</div>
          <div class="chip" onclick="sendSuggestion('What are tips for a healthier heart?')">Heart health tips</div>
          <div class="chip" onclick="sendSuggestion('How fast does HealthCone alert a hospital?')">Alert speed?</div>
        </div>
      </div>
    </div>

    <!-- INPUT -->
    <div class="input-area">
      <div class="mobile-model">
        <select id="modelSelectMobile" onchange="syncModel(this.value)">
          <option value="groq-1">Groq â€” LLaMA 3.3 70B #1</option>
          <option value="groq-2">Groq â€” LLaMA 3.3 70B #2</option>
          <option value="groq-3">Groq â€” LLaMA 3.3 70B #3</option>
          <option value="groq-4">Groq â€” LLaMA 3.3 70B #4</option>
        </select>
      </div>
      <div class="input-row">
        <div class="input-wrap">
          <textarea
            id="msgInput"
            placeholder="Ask about heart health, HealthCone, or wellness..."
            rows="1"
            onkeydown="handleKey(event)"
            oninput="autoResize(this)"
          ></textarea>
          <button class="send-btn" id="sendBtn" onclick="sendMessage()" title="Send message">
            <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22 2 15 22 11 13 2 9 22 2"/>
            </svg>
          </button>
        </div>
      </div>
      <div class="input-footer">
        HealthCone AI assists but does not replace professional medical care Â·
        Powered by <a href="https://bruno-gpt5.vercel.app" target="_blank" rel="noopener">Bruno-GPT5</a>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chatSessions   = [];
let currentMsgs    = [];   // { role: 'user'|'assistant', content: '...' }
let currentSessId  = null;
let isLoading      = false;

// Load saved sessions from localStorage
try {
  chatSessions = JSON.parse(localStorage.getItem('hc_sessions') || '[]');
} catch (_) {
  chatSessions = [];
}

renderHistory();

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getModel() {
  return document.getElementById('modelSelect').value;
}

function syncModel(val) {
  document.getElementById('modelSelect').value = val;
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 140) + 'px';
}

function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function sendSuggestion(text) {
  const inp = document.getElementById('msgInput');
  inp.value = text;
  autoResize(inp);
  sendMessage();
}

function toggleMenu() {
  document.getElementById('mobileMenu').classList.toggle('open');
}

// â”€â”€ FORMAT MARKDOWN-LIKE TEXT â†’ SAFE HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function formatMessage(raw) {
  // Escape HTML entities first
  let t = raw
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Code blocks (``` ```)
  t = t.replace(/```[\w]*\n?([\s\S]*?)```/g, (_, code) =>
    `<pre style="background:rgba(0,0,0,0.3);border-radius:8px;padding:0.8rem 1rem;overflow-x:auto;margin:0.5rem 0"><code style="color:var(--cyan);font-family:monospace;font-size:0.84em">${code.trim()}</code></pre>`
  );

  // Inline code
  t = t.replace(/`([^`\n]+)`/g, '<code>$1</code>');

  // Bold
  t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  t = t.replace(/__(.+?)__/g,     '<strong>$1</strong>');

  // Italic
  t = t.replace(/\*([^*\n]+)\*/g, '<em>$1</em>');
  t = t.replace(/_([^_\n]+)_/g,   '<em>$1</em>');

  // Headings (### ## #)
  t = t.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  t = t.replace(/^## (.+)$/gm,  '<h3>$1</h3>');
  t = t.replace(/^# (.+)$/gm,   '<h3>$1</h3>');

  // Horizontal rule
  t = t.replace(/^---+$/gm, '<hr/>');

  // Unordered lists
  t = t.replace(/^[-*â€¢] (.+)$/gm, '<li>$1</li>');
  t = t.replace(/(<li>.*?<\/li>\n?)+/gs, match => `<ul>${match}</ul>`);

  // Ordered lists
  t = t.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');

  // Line breaks â†’ <br>
  t = t.replace(/\n\n/g, '<br/><br/>');
  t = t.replace(/\n/g, '<br/>');

  return t;
}

// â”€â”€ APPEND A BUBBLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendMessage(role, text, isError = false) {
  const container = document.getElementById('messages');

  const wrap = document.createElement('div');
  wrap.className = `msg ${role}` + (isError ? ' msg-error' : '');

  const avatarText = role === 'ai' ? 'HC' : 'YOU';
  wrap.innerHTML = `
    <div class="msg-avatar">${avatarText}</div>
    <div class="msg-bubble">${role === 'ai' ? formatMessage(text) : escapeHtml(text)}</div>
  `;

  container.appendChild(wrap);
  container.scrollTop = container.scrollHeight;
}

function escapeHtml(t) {
  return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// â”€â”€ TYPING INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTyping() {
  const id = 'typing_' + Date.now();
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg ai';
  div.id = id;
  div.innerHTML = `
    <div class="msg-avatar">HC</div>
    <div class="typing-bubble">
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    </div>
  `;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
  return id;
}

function removeTyping(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

// â”€â”€ SEND MESSAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sendMessage() {
  const input = document.getElementById('msgInput');
  const text  = input.value.trim();
  if (!text || isLoading) return;

  // Remove welcome screen on first message
  const welcome = document.getElementById('welcomeScreen');
  if (welcome) welcome.remove();

  // Build message and update UI
  currentMsgs.push({ role: 'user', content: text });
  appendMessage('user', text);
  input.value = '';
  input.style.height = 'auto';

  const typingId = showTyping();
  isLoading = true;
  document.getElementById('sendBtn').disabled = true;

  try {
    const res = await fetch('/api/chat', {
      method:  'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messages: currentMsgs,
        model:    getModel(),
      }),
    });

    removeTyping(typingId);

    const data = await res.json();

    if (!res.ok) {
      // Server returned an error
      const errMsg = data.error || 'Something went wrong. Please try again.';
      appendMessage('ai', 'âš ï¸ ' + errMsg, true);
    } else {
      // Our backend always returns { reply: '...' }
      const reply = data.reply || 'I received an empty response. Please try again.';
      currentMsgs.push({ role: 'assistant', content: reply });
      appendMessage('ai', reply);
      saveSession(text);
    }

  } catch (err) {
    removeTyping(typingId);
    appendMessage('ai', 'âš ï¸ Network error â€” please check your connection and try again.', true);
    console.error('Chat fetch error:', err);
  }

  isLoading = false;
  document.getElementById('sendBtn').disabled = false;
  document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
}

// â”€â”€ SESSION MANAGEMENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSession(firstMessage) {
  if (!currentSessId) {
    currentSessId = String(Date.now());
    const title = firstMessage.length > 42
      ? firstMessage.slice(0, 42) + 'â€¦'
      : firstMessage;
    chatSessions.unshift({ id: currentSessId, title, messages: [], ts: Date.now() });
  }
  const sess = chatSessions.find(s => s.id === currentSessId);
  if (sess) sess.messages = [...currentMsgs];

  // Keep only the 30 most recent sessions
  if (chatSessions.length > 30) chatSessions = chatSessions.slice(0, 30);

  try {
    localStorage.setItem('hc_sessions', JSON.stringify(chatSessions));
  } catch (_) { /* storage full â€” silently ignore */ }

  renderHistory();
}

function newChat() {
  currentMsgs   = [];
  currentSessId = null;

  const container = document.getElementById('messages');
  container.innerHTML = `
    <div class="welcome" id="welcomeScreen">
      <div class="welcome-icon">ğŸ¥</div>
      <h2>HealthCone AI Assistant</h2>
      <p>Powered by Bruno-GPT5 â€” ask anything about heart health, HealthCone features, wellness tips, or emergency guidance.</p>
      <div class="suggestion-chips">
        <div class="chip" onclick="sendSuggestion('What is HealthCone and how does it work?')">What is HealthCone?</div>
        <div class="chip" onclick="sendSuggestion('What heart rate is considered dangerous?')">Dangerous heart rate?</div>
        <div class="chip" onclick="sendSuggestion('What should I do during a cardiac emergency?')">Cardiac emergency steps</div>
        <div class="chip" onclick="sendSuggestion('How does HealthCone detect heart problems?')">How does detection work?</div>
        <div class="chip" onclick="sendSuggestion('What are tips for a healthier heart?')">Heart health tips</div>
        <div class="chip" onclick="sendSuggestion('How fast does HealthCone alert a hospital?')">Alert speed?</div>
      </div>
    </div>
  `;
  renderHistory();
}

function loadSession(id) {
  const sess = chatSessions.find(s => s.id === id);
  if (!sess) return;

  currentSessId = id;
  currentMsgs   = [...(sess.messages || [])];

  const container = document.getElementById('messages');
  container.innerHTML = '';
  currentMsgs.forEach(m =>
    appendMessage(m.role === 'user' ? 'user' : 'ai', m.content)
  );
  container.scrollTop = container.scrollHeight;
  renderHistory();
}

function renderHistory() {
  const hist = document.getElementById('chatHistory');
  hist.innerHTML = '';
  chatSessions.forEach(s => {
    const div = document.createElement('div');
    div.className = 'history-item' + (s.id === currentSessId ? ' active' : '');
    div.textContent = s.title;
    div.title = s.title;
    div.onclick = () => loadSession(s.id);
    hist.appendChild(div);
  });
}
</script>
</body>
</html>
