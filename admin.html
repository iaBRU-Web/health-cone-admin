<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard — HealthCone</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet"/>
</head>
<body>

<nav>
  <a href="https://health-cone.vercel.app/" class="nav-logo">
    <svg viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="15" stroke="#00e5c8" stroke-width="1.5"/><path d="M6 16 L10 11 L13 18 L16 8 L19 20 L22 14 L26 16" stroke="#00e5c8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 22 C16 22 12 18.5 12 16.5 C12 14.8 13.3 14 14.5 14 C15.3 14 16 14.6 16 14.6 C16 14.6 16.7 14 17.5 14 C18.7 14 20 14.8 20 16.5 C20 18.5 16 22 16 22Z" fill="#00e5c8" opacity="0.7"/></svg>
    Health<span style="color:var(--cyan)">Cone</span>
  </a>
  <div class="nav-links">
    <a href="https://health-cone.vercel.app/">Home</a><a href="https://health-cone.vercel.app/features.html">Features</a><a href="https://health-cone.vercel.app/about.html">About</a>
    <a href="https://health-cone.vercel.app/assistant.html">AI Assistant</a><a href="https://health-cone.vercel.app/admin.html" class="active">Admin</a>
    <a href="https://health-cone.vercel.app/assistant.html" class="nav-cta">Try Now →</a>
  </div>
  <div class="hamburger" onclick="toggleMenu()"><span></span><span></span><span></span></div>
</nav>

<div class="mobile-menu" id="mobileMenu">
  <a href="https://health-cone.vercel.app/">Home</a><a href="https://health-cone.vercel.app/features.html">Features</a><a href="https://health-cone.vercel.app/about.html">About</a><a href="https://health-cone.vercel.app/assistant.html">AI Assistant</a><a href="https://health-cone.vercel.app/admin.html" class="active">Admin</a>
</div>

<div class="wrap">
  <!-- HEADER -->
  <div class="admin-header">
    <div class="admin-header-left">
      <div class="label">Admin Dashboard</div>
      <h1>System Overview</h1>
    </div>
    <div class="admin-header-right">
      <div class="live-badge"><div class="live-dot"></div> Live</div>
      <div class="last-update" id="lastUpdate">Loading...</div>
      <button class="refresh-btn" onclick="loadStats()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        Refresh
      </button>
    </div>
  </div>

  <!-- STATS GRID -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card"><div class="stat-card-label">Total Users</div><div class="stat-card-value loading-shimmer" id="sv-users"></div></div>
    <div class="stat-card alert-card"><div class="stat-card-label">Active Alerts</div><div class="stat-card-value danger loading-shimmer" id="sv-alerts"></div></div>
    <div class="stat-card"><div class="stat-card-label">Hospitals Connected</div><div class="stat-card-value good loading-shimmer" id="sv-hospitals"></div></div>
    <div class="stat-card"><div class="stat-card-label">Emergencies / Month</div><div class="stat-card-value loading-shimmer" id="sv-emergencies"></div></div>
    <div class="stat-card"><div class="stat-card-label">Avg Response Time</div><div class="stat-card-value good loading-shimmer" id="sv-response"></div></div>
    <div class="stat-card"><div class="stat-card-label">System Uptime</div><div class="stat-card-value good loading-shimmer" id="sv-uptime"></div></div>
  </div>

  <!-- TWO COL: Alerts + Chart -->
  <div class="two-col">
    <!-- ACTIVE ALERTS -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Active Alerts</div>
        <span class="panel-badge badge-red" id="alertCount">—</span>
      </div>
      <div class="panel-body" style="padding:0">
        <table class="alert-table">
          <thead><tr><th>User</th><th>BPM</th><th>Location</th><th>Severity</th><th>Action</th></tr></thead>
          <tbody id="alertsBody"><tr><td colspan="5" style="text-align:center;color:var(--text-dim);padding:2rem">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>

    <!-- CHART -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">Avg Heart Rate — Last 24h</div>
        <span class="panel-badge badge-green">BPM Trend</span>
      </div>
      <div class="panel-body">
        <div class="chart-wrap">
          <canvas id="bpmChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- TWO COL: System Status + Submit Health Data -->
  <div class="two-col" style="margin-bottom:3rem">
    <!-- SYSTEM STATUS -->
    <div class="panel">
      <div class="panel-header"><div class="panel-title">System Status</div><span class="panel-badge badge-green">Operational</span></div>
      <div class="panel-body">
        <div class="system-rows">
          <div class="sys-row"><span class="sys-row-label"><span class="status-dot dot-green"></span>AI Engine (Bruno-GPT5)</span><span class="sys-row-val">Operational</span></div>
          <div class="sys-row"><span class="sys-row-label"><span class="status-dot dot-green"></span>Alert Pipeline</span><span class="sys-row-val">Active</span></div>
          <div class="sys-row"><span class="sys-row-label"><span class="status-dot dot-green"></span>Hospital Network</span><span class="sys-row-val" id="sv-hospitals2">12 connected</span></div>
          <div class="sys-row"><span class="sys-row-label"><span class="status-dot dot-green"></span>GPS Location Service</span><span class="sys-row-val">Active</span></div>
          <div class="sys-row"><span class="sys-row-label"><span class="status-dot dot-green"></span>Cloud Backend (Vercel)</span><span class="sys-row-val">99.98% uptime</span></div>
          <div class="sys-row"><span class="sys-row-label"><span class="status-dot dot-green"></span>Data Encryption</span><span class="sys-row-val">TLS 1.3</span></div>
        </div>
      </div>
    </div>

    <!-- SUBMIT HEALTH DATA -->
    <div class="panel">
      <div class="panel-header"><div class="panel-title">Submit Health Data</div><span class="panel-badge badge-green">API Test</span></div>
      <div class="panel-body">
        <p style="font-size:0.82rem;color:var(--text-dim);margin-bottom:1rem;line-height:1.6">Test the health data ingestion API. Submit a heart rate reading to see how the system classifies it and whether it triggers an alert.</p>
        <div class="submit-form">
          <div class="form-row">
            <input class="form-input" id="f-userId" placeholder="User ID (e.g. User #123)"/>
            <input class="form-input" id="f-bpm" type="number" placeholder="BPM (e.g. 145)"/>
          </div>
          <input class="form-input" id="f-location" placeholder="Location (e.g. Kigali, RW)"/>
          <button class="submit-health-btn" onclick="submitHealthData()">Submit Reading →</button>
          <div class="submit-result" id="submitResult"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="footer-inner">
    <div class="footer-logo">Health<span style="color:var(--cyan)">Cone</span></div>
    <div class="footer-links"><a href="https://health-cone.vercel.app/">Home</a><a href="https://health-cone.vercel.app/features.html">Features</a><a href="https://health-cone.vercel.app/about.html">About</a><a href="https://health-cone.vercel.app/assistant.html">AI Assistant</a><a href="https://health-cone.vercel.app/admin.html">Admin</a></div>
    <div>Created by <a href="https://health-cone.vercel.app/about.html">INEZA AIME BRUNO</a> · Rwanda</div>
  </div>
</footer>
<style>
  :root{--green-deep:#0d2b1a;--green-mid:#1a4d2e;--green-bright:#2d7a4f;--cyan:#00e5c8;--cyan-dim:#00b49e;--ivory:#f5f0e8;--red-alert:#ff4d4d;--amber:#ffb347;--text-main:#f5f0e8;--text-dim:#9ab8a8;--card-bg:rgba(255,255,255,0.04);--card-border:rgba(0,229,200,0.12)}
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html{scroll-behavior:smooth}
  body{font-family:'DM Sans',sans-serif;background:var(--green-deep);color:var(--text-main);min-height:100vh;overflow-x:hidden}
  body::before{content:'';position:fixed;inset:0;z-index:0;background:radial-gradient(ellipse 60% 40% at 5% 5%,rgba(0,229,200,0.04) 0%,transparent 60%),radial-gradient(ellipse 40% 50% at 95% 95%,rgba(45,122,79,0.06) 0%,transparent 60%);pointer-events:none}
  nav{position:fixed;top:0;left:0;right:0;z-index:100;padding:0 2rem;height:68px;display:flex;align-items:center;justify-content:space-between;background:rgba(13,43,26,0.9);backdrop-filter:blur(20px);border-bottom:1px solid var(--card-border)}
  .nav-logo{display:flex;align-items:center;gap:10px;text-decoration:none;font-family:'Syne',sans-serif;font-weight:800;font-size:1.25rem;color:var(--text-main)}
  .nav-logo svg{width:32px;height:32px}
  .nav-links{display:flex;align-items:center;gap:0.25rem}
  .nav-links a{text-decoration:none;color:var(--text-dim);font-size:0.88rem;font-weight:500;padding:0.45rem 1rem;border-radius:8px;transition:color 0.2s,background 0.2s}
  .nav-links a:hover,.nav-links a.active{color:var(--cyan);background:rgba(0,229,200,0.08)}
  .nav-cta{background:var(--cyan);color:var(--green-deep)!important;font-weight:700!important;padding:0.45rem 1.2rem!important;border-radius:8px}
  .hamburger{display:none;flex-direction:column;gap:5px;cursor:pointer;padding:4px}
  .hamburger span{display:block;width:24px;height:2px;background:var(--text-main);border-radius:2px}
  .mobile-menu{display:none;position:fixed;top:68px;left:0;right:0;background:rgba(13,43,26,0.97);backdrop-filter:blur(20px);border-bottom:1px solid var(--card-border);padding:1rem 2rem 1.5rem;flex-direction:column;gap:0.5rem;z-index:99}
  .mobile-menu.open{display:flex}
  .mobile-menu a{text-decoration:none;color:var(--text-dim);font-size:1rem;padding:0.6rem 0;border-bottom:1px solid var(--card-border)}
  .mobile-menu a:hover,.mobile-menu a.active{color:var(--cyan)}
  @media(max-width:768px){.nav-links{display:none}.hamburger{display:flex}}

  .wrap{position:relative;z-index:1;max-width:1400px;margin:0 auto;padding:0 2rem}

  /* HEADER */
  .admin-header{padding:5.5rem 0 2.5rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem;border-bottom:1px solid var(--card-border)}
  .admin-header-left .label{font-size:0.7rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;color:var(--cyan);margin-bottom:0.4rem}
  .admin-header-left h1{font-family:'Syne',sans-serif;font-size:1.8rem;font-weight:800}
  .admin-header-right{display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
  .live-badge{display:flex;align-items:center;gap:6px;background:rgba(0,229,200,0.1);border:1px solid rgba(0,229,200,0.2);color:var(--cyan);font-size:0.75rem;font-weight:600;padding:0.4rem 0.9rem;border-radius:100px}
  .live-dot{width:7px;height:7px;background:var(--cyan);border-radius:50%;animation:pulse 1.8s infinite}
  .refresh-btn{background:rgba(255,255,255,0.06);border:1px solid var(--card-border);color:var(--text-main);font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;transition:background 0.2s;display:flex;align-items:center;gap:6px}
  .refresh-btn:hover{background:rgba(255,255,255,0.1)}
  .last-update{font-size:0.75rem;color:var(--text-dim);font-family:'DM Mono',monospace}
  @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,229,200,0.5)}50%{box-shadow:0 0 0 6px rgba(0,229,200,0)}}

  /* STATS GRID */
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.2rem;padding:2rem 0}
  .stat-card{background:var(--card-bg);border:1px solid var(--card-border);border-radius:14px;padding:1.5rem;transition:border-color 0.3s}
  .stat-card:hover{border-color:rgba(0,229,200,0.25)}
  .stat-card.alert-card{border-color:rgba(255,77,77,0.25);background:rgba(255,77,77,0.04)}
  .stat-card-label{font-size:0.72rem;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);margin-bottom:0.8rem}
  .stat-card-value{font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;color:var(--text-main);line-height:1}
  .stat-card-value.danger{color:var(--red-alert)}
  .stat-card-value.good{color:var(--cyan)}
  .stat-card-sub{font-size:0.77rem;color:var(--text-dim);margin-top:0.4rem}

  /* TWO COLUMN */
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem}
  @media(max-width:900px){.two-col{grid-template-columns:1fr}}

  /* PANEL */
  .panel{background:var(--card-bg);border:1px solid var(--card-border);border-radius:16px;overflow:hidden}
  .panel-header{padding:1.2rem 1.5rem;border-bottom:1px solid var(--card-border);display:flex;align-items:center;justify-content:space-between}
  .panel-title{font-family:'Syne',sans-serif;font-size:0.9rem;font-weight:700}
  .panel-badge{font-size:0.7rem;font-weight:700;padding:0.25rem 0.6rem;border-radius:6px}
  .badge-red{background:rgba(255,77,77,0.15);color:var(--red-alert)}
  .badge-green{background:rgba(0,229,200,0.1);color:var(--cyan)}
  .panel-body{padding:1.2rem 1.5rem}

  /* ALERT TABLE */
  .alert-table{width:100%;border-collapse:collapse}
  .alert-table th{text-align:left;font-size:0.68rem;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;color:var(--text-dim);padding:0.5rem 0.8rem;border-bottom:1px solid var(--card-border)}
  .alert-table td{padding:0.75rem 0.8rem;font-size:0.83rem;border-bottom:1px solid rgba(255,255,255,0.03);vertical-align:middle}
  .alert-table tr:last-child td{border-bottom:none}
  .alert-table tr:hover td{background:rgba(255,255,255,0.02)}
  .severity-critical{color:var(--red-alert);font-weight:700;font-size:0.72rem}
  .severity-warning{color:var(--amber);font-weight:700;font-size:0.72rem}
  .severity-info{color:var(--cyan);font-size:0.72rem}
  .bpm-value{font-family:'DM Mono',monospace;font-size:0.88rem}
  .bpm-critical{color:var(--red-alert)}
  .bpm-warning{color:var(--amber)}
  .bpm-ok{color:var(--cyan)}
  .resolve-btn{background:rgba(0,229,200,0.1);border:1px solid rgba(0,229,200,0.2);color:var(--cyan);font-size:0.72rem;font-weight:600;padding:0.2rem 0.6rem;border-radius:5px;cursor:pointer;transition:background 0.2s}
  .resolve-btn:hover{background:rgba(0,229,200,0.2)}
  .resolved-tag{font-size:0.7rem;color:var(--text-dim)}

  /* CHART */
  .chart-wrap{height:160px;position:relative;margin-top:0.5rem}
  canvas{width:100%!important;height:100%!important}

  /* SYSTEM STATUS */
  .system-rows{display:flex;flex-direction:column;gap:0.6rem}
  .sys-row{display:flex;align-items:center;justify-content:space-between;padding:0.65rem 0;border-bottom:1px solid rgba(255,255,255,0.04)}
  .sys-row:last-child{border-bottom:none}
  .sys-row-label{font-size:0.85rem;color:var(--text-dim)}
  .sys-row-val{font-family:'DM Mono',monospace;font-size:0.82rem;color:var(--text-main)}
  .status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:6px}
  .dot-green{background:var(--cyan)}
  .dot-red{background:var(--red-alert)}

  /* Submit health data */
  .submit-form{display:flex;flex-direction:column;gap:0.8rem}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:0.6rem}
  .form-input{background:rgba(255,255,255,0.05);border:1px solid var(--card-border);color:var(--text-main);font-family:'DM Sans',sans-serif;font-size:0.85rem;padding:0.6rem 0.9rem;border-radius:8px;outline:none;transition:border-color 0.2s;width:100%}
  .form-input:focus{border-color:var(--cyan)}
  .form-input::placeholder{color:var(--text-dim)}
  .submit-health-btn{background:var(--cyan);color:var(--green-deep);font-family:'Syne',sans-serif;font-weight:700;font-size:0.88rem;padding:0.7rem 1.2rem;border:none;border-radius:8px;cursor:pointer;transition:opacity 0.2s}
  .submit-health-btn:hover{opacity:0.85}
  .submit-result{font-size:0.82rem;padding:0.6rem 0.9rem;border-radius:8px;display:none}
  .submit-result.ok{background:rgba(0,229,200,0.1);color:var(--cyan)}
  .submit-result.err{background:rgba(255,77,77,0.1);color:var(--red-alert)}

  footer{position:relative;z-index:1;border-top:1px solid var(--card-border);padding:2rem 2rem;color:var(--text-dim);font-size:0.85rem;margin-top:2rem}
  .footer-inner{max-width:1400px;margin:0 auto;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:1rem}
  .footer-logo{font-family:'Syne',sans-serif;font-weight:800;color:var(--text-main)}
  .footer-links{display:flex;gap:1.5rem;flex-wrap:wrap}
  .footer-links a{color:var(--text-dim);text-decoration:none;transition:color 0.2s}
  .footer-links a:hover{color:var(--cyan)}
  footer a{color:var(--cyan);text-decoration:none}
  .loading-shimmer{background:linear-gradient(90deg,rgba(255,255,255,0.04) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.04) 75%);background-size:200% 100%;animation:shimmer 1.4s infinite;border-radius:6px;height:2rem}
  @keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script>
  let chartInstance = null;

  // ── LOAD STATS ──
  async function loadStats() {
    try {
      const res = await fetch('https://health-cone-backend.vercel.app/api/stats');
      const data = await res.json();

      // Update stat cards
      setText('sv-users', data.totalUsers?.toLocaleString() || '—');
      setText('sv-alerts', data.activeAlerts ?? '—');
      setText('sv-hospitals', data.hospitalsConnected ?? '—');
      setText('sv-emergencies', data.emergenciesThisMonth ?? '—');
      setText('sv-response', data.avgResponseTime || '—');
      setText('sv-uptime', data.uptime || '—');
      setText('sv-hospitals2', (data.hospitalsConnected || '—') + ' connected');
      setText('alertCount', (data.activeAlerts || 0) + ' active');

      // Remove shimmer
      document.querySelectorAll('.loading-shimmer').forEach(el => el.classList.remove('loading-shimmer'));

      // Last updated
      const d = new Date(data.lastUpdated);
      document.getElementById('lastUpdate').textContent = 'Updated: ' + d.toLocaleTimeString();

      // Render alerts
      renderAlerts(data.recentAlerts || []);

      // Render chart
      renderChart(data.chartData || []);

    } catch (err) {
      console.error('Stats error:', err);
      document.getElementById('lastUpdate').textContent = 'Error loading data';
    }
  }

  function setText(id, val) {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
  }

  // ── RENDER ALERTS ──
  function renderAlerts(alerts) {
    const tbody = document.getElementById('alertsBody');
    if (!alerts.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-dim);padding:1.5rem">No alerts</td></tr>';
      return;
    }
    tbody.innerHTML = alerts.map(a => {
      const bpmClass = a.bpm > 130 || a.bpm < 50 ? 'bpm-critical' : a.bpm > 100 || a.bpm < 60 ? 'bpm-warning' : 'bpm-ok';
      const sevClass = a.severity === 'critical' ? 'severity-critical' : a.severity === 'warning' ? 'severity-warning' : 'severity-info';
      const timeStr = timeAgo(a.time);
      const action = a.resolved
        ? '<span class="resolved-tag">✓ Resolved</span>'
        : `<button class="resolve-btn" onclick="resolveAlert(${a.id})">Resolve</button>`;
      return `<tr>
        <td><div style="font-size:0.85rem">${a.user}</div><div style="font-size:0.72rem;color:var(--text-dim)">${timeStr}</div></td>
        <td><span class="bpm-value ${bpmClass}">${a.bpm}</span></td>
        <td style="color:var(--text-dim);font-size:0.8rem">${a.location}</td>
        <td><span class="${sevClass}">${a.severity.toUpperCase()}</span></td>
        <td>${action}</td>
      </tr>`;
    }).join('');
  }

  // ── RENDER CHART ──
  function renderChart(chartData) {
    const ctx = document.getElementById('bpmChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.map(d => d.hour),
        datasets: [{
          label: 'Avg BPM',
          data: chartData.map(d => d.avgBpm),
          borderColor: '#00e5c8',
          backgroundColor: 'rgba(0,229,200,0.08)',
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: '#00e5c8',
          fill: true,
          tension: 0.4,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#9ab8a8', font: { size: 10 }, maxTicksLimit: 8 }, grid: { color: 'rgba(255,255,255,0.04)' } },
          y: { ticks: { color: '#9ab8a8', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.04)' }, suggestedMin: 50, suggestedMax: 100 }
        }
      }
    });
  }

  // ── RESOLVE ALERT ──
  async function resolveAlert(id) {
    try {
      await fetch(`https://health-cone-backend.vercel.app/api/stats?action=resolve&id=${id}`);
      loadStats();
    } catch (e) { console.error(e); }
  }

  // ── SUBMIT HEALTH DATA ──
  async function submitHealthData() {
    const userId = document.getElementById('f-userId').value.trim();
    const bpm = parseInt(document.getElementById('f-bpm').value);
    const location = document.getElementById('f-location').value.trim();
    const resultEl = document.getElementById('submitResult');

    if (!userId || !bpm) {
      resultEl.textContent = 'Please fill in User ID and BPM.';
      resultEl.className = 'submit-result err';
      resultEl.style.display = 'block';
      return;
    }

    try {
      const res = await fetch('https://health-cone-backend.vercel.app/api/stats', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, bpm, location: location || 'Unknown' })
      });
      const data = await res.json();
      resultEl.textContent = data.alert
        ? `⚠️ ALERT TRIGGERED: ${bpm} BPM is ${data.log.severity}. Emergency protocol activated.`
        : `✓ Reading accepted: ${bpm} BPM is within normal range. No alert.`;
      resultEl.className = 'submit-result ' + (data.alert ? 'err' : 'ok');
      resultEl.style.display = 'block';
      loadStats();
    } catch (e) {
      resultEl.textContent = 'Error submitting data. Try again.';
      resultEl.className = 'submit-result err';
      resultEl.style.display = 'block';
    }
  }

  // ── HELPERS ──
  function timeAgo(ts) {
    const s = Math.floor((Date.now() - ts) / 1000);
    if (s < 60) return s + 's ago';
    if (s < 3600) return Math.floor(s/60) + 'min ago';
    return Math.floor(s/3600) + 'h ago';
  }

  function toggleMenu() { document.getElementById('mobileMenu').classList.toggle('open'); }

  // ── AUTO REFRESH ──
  loadStats();
  setInterval(loadStats, 30000);
</script>
</body>
</html>
